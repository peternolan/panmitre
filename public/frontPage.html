<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

<!--  -->
<p>Hello world!</p>

<script >

  var patient_arr = [];
  var code_arr = [];


  getPatients();

  async function executeSearch (codes) {

    var codeList = '';
    var index = 0;
    while (index < codes.length) {
      if (index < codes.length - 1) {
        codeList += codes[index] + '+';
      }
      else {
        codeList += codes[index];
      }
      index++;
    }

    console.log (codeList);

    const response = await fetch('https://rxnav.nlm.nih.gov/REST/interaction/list.json?rxcuis='+codeList);
    const myJson = await response.json(); //extract JSON from the http response
    console.log('USER ACTION ACTIVATED');
    console.log(myJson)
  }

  function getPatients() {

    let xml = new XMLHttpRequest();

    console.log('getPatientIds');
    xml.open('GET', '/getPatients');
    xml.responseType = 'json';
    xml.onload = function() {

        patient_arr = xml.response;
        for (var i in patient_arr) {
          var object = patient_arr[i];
          getCodes(object)
        }

    };

    xml.send();

  }

  function getCodes(patient) {
    console.log(patient);
    let xml = new XMLHttpRequest();
    xml.open('POST', '/getCodes');
    xml.setRequestHeader('Content-Type', 'application/json');
    xml.responseType = 'json';
    xml.onload = function() {
      code_arr = xml.response;
      var codes = [];

      for (var i in code_arr) {
        var object = code_arr[i];
        codes.push(object["code"]);

      }

      executeSearch(codes);


    };
    xml.send(JSON.stringify(patient));

  }



</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

<!--  -->
<p>Hello world!</p>

<div id ="results">

</div>

<script >

  var patient_arr = [];
  var code_arr = [];
  var name_arr = [];


  getPatients();

  /**
   * Executes a RXNav
   * @param codes: Medication Codes to use in RXNav search.
   * @param patient: Current Patient ID
   * @returns {Promise<void>}
   */
  async function executeSearch (codes, patient) {
    console.log('Execute Search');
    var codeList = '';
    var index = 0;
    while (index < codes.length) {
      if (index < codes.length - 1) {
        codeList += codes[index] + '+';
      }
      else {
        codeList += codes[index];
      }
      index++;
    }

    console.log(codeList);
    console.log(patient);

    const response = await fetch('https://rxnav.nlm.nih.gov/REST/interaction/list.json?rxcuis='+codeList);
    const myJson = await response.json(); //extract JSON from the http response

    if (myJson.hasOwnProperty('fullInteractionTypeGroup')) {
      console.log(myJson);
      let xml = new XMLHttpRequest();
      xml.open('POST', '/getName');
      xml.setRequestHeader('Content-Type', 'application/json');
      xml.onload  = function() {
        console.log('onload');
        name_arr.concat(xml.response)
      }
      xml.responseType = 'json';
      xml.send(JSON.stringify(patient));
    }


  }

  function getPatients() {

    let xml = new XMLHttpRequest();

    console.log('getPatientIds');
    xml.open('GET', '/getPatients');
    xml.responseType = 'json';
    xml.onload = function() {

        patient_arr = xml.response;
        for (var i in patient_arr) {
          var object = patient_arr[i];
          getCodes(object)
        }
        build(name_arr);

    };

    xml.send();

  }


  function getCodes(patient) {
    console.log(patient);
    let xml = new XMLHttpRequest();
    xml.open('POST', '/getCodes');
    xml.setRequestHeader('Content-Type', 'application/json');
    xml.responseType = 'json';
    xml.onload = function() {
      console.log('onload getCodes');
      code_arr = xml.response;
      var codes = [];

      for (var i in code_arr) {
        var object = code_arr[i];
        codes.push(object["code"]);


      }
      executeSearch(codes, patient);



    };
    xml.send(JSON.stringify(patient));

  }

  function build( name_arr ) {
    console.log('Build');
    var results_html = `${
      name_arr.map(name =>
        `<div>
              <span>${name.suffixes}</span> |
              <span>${name.first}</span> |
              <span>${name.last}</span> |
         </div>`
      ).join('')
      }`;
    document.getElementById('results').innerHTML = results_html;
  }


</script>

</body>
</html>
